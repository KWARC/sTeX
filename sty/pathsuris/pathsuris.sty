%%
%% This is file `pathsuris.sty',
%% generated with the docstrip utility.
%%
%% The original source files were:
%%
%% pathsuris.dtx  (with options: `package')
%% 
\NeedsTeXFormat{LaTeX2e}[1999/12/01]
\ProvidesPackage{pathsuris}[2020/09/30 v2.1 Paths and URIs for sTeX]

\RequirePackage{stex-base}
\RequirePackage{xstring}
\RequirePackage{etoolbox}
\newcommand\baseURI[2][]{}
\newrobustcmd\defpath[3][]{%
  \expandafter\newcommand\csname #2\endcsname[1]{#3/##1}%
}%
\def\pathsuris@setcatcodes{%
    \edef\pathsuris@oldcatcode@hash{\the\catcode`\#}%
    \catcode`\#=12\relax%
    \edef\pathsuris@oldcatcode@slash{\the\catcode`\/}%
    \catcode`\/=12\relax%
    \edef\pathsuris@oldcatcode@colon{\the\catcode`\:}%
    \catcode`\:=12\relax%
    \edef\pathsuris@oldcatcode@qm{\the\catcode`\?}%
    \catcode`\?=12\relax%
}
\def\pathsuris@resetcatcodes{%
    \catcode`\#\pathsuris@oldcatcode@hash\relax%
    \catcode`\/\pathsuris@oldcatcode@slash\relax%
    \catcode`\:\pathsuris@oldcatcode@colon\relax%
    \catcode`\?\pathsuris@oldcatcode@qm\relax%
}
\def\@ToTop{..}
\def\@Slash{/}
\def\@Colon{:}
\def\@QuestionMark{?}
\def\@ToHere{.}

\pathsuris@setcatcodes
\def\@Fragment{#}
\pathsuris@resetcatcodes
\def\@cpath#1{%
    \edef\pathsuris@temp{#1}%
    \def\@CanPath{}%
    \IfBeginWith\pathsuris@temp\@Slash{%
      \@cpath@loop%
      \edef\@CanPath{\@Slash\@CanPath}%
    }{%
      \@cpath@loop%
    }%
    \IfEndWith\@CanPath\@Slash{%
      \ifx\@CanPath\@Slash\else%
        \StrGobbleRight\@CanPath1[\@CanPath]%
      \fi%
    }{}%
}

\def\@cpath@loop{%
    \IfSubStr\pathsuris@temp\@Slash{%
        \StrCut\pathsuris@temp\@Slash\pathsuris@temp@a\pathsuris@temp%
        \ifx\pathsuris@temp@a\@ToTop%
            \ifx\@CanPath\@empty%
                \edef\@CanPath{\@ToTop}%
            \else%
                \edef\@CanPath{\@CanPath\@Slash\@ToTop}%
            \fi%
            \@cpath@loop%
        \else%
        \IfBeginWith\pathsuris@temp\@ToTop{%
            \StrBehind{\pathsuris@temp}{\@ToTop}[\pathsuris@temp]%
            \IfBeginWith\pathsuris@temp\@Slash{%
                \edef\pathsuris@temp{\@CanPath\pathsuris@temp}%
            }{%
                \ifx\@CanPath\@empty\else%
                    \edef\pathsuris@temp{\@CanPath\@Slash\pathsuris@temp}
                \fi%
            }%
            \def\@CanPath{}%
            \@cpath@loop%
        }{%
            \ifx\@CanPath\@empty%
                \edef\@CanPath{\pathsuris@temp@a}%
            \else%
                \edef\@CanPath{\@CanPath\@Slash\pathsuris@temp@a}%
            \fi%
            \@cpath@loop
        }%
        \fi%
    }{
        \ifx\@CanPath\@empty%
            \edef\@CanPath{\pathsuris@temp}%
        \else%
            \edef\@CanPath{\@CanPath\@Slash\pathsuris@temp}%
        \fi%
    }%
}
\newcommand\cpath[1]{%
    \@cpath{#1}%
    \@CanPath%
}
\newif\if@pathsuris@done@

\def\seturi@[#1]#2{%
    \@pathsuris@done@false%
    \def\pathsuris@prefix@temp{#1}
    \edef\pathsuris@curruri{#2}%
    \edef\pathsuris@temp{\pathsuris@curruri}%
    \def\pathsuris@curruri@scheme{}%
    \def\pathsuris@curruri@authority{}%
    \def\pathsuris@curruri@path{}%
    \def\pathsuris@curruri@query{}%
    \def\pathsuris@curruri@fragment{}%
    % scheme
    \IfSubStr{\pathsuris@temp}{\@Colon}{%
        % TODO check for valid scheme
        \StrBefore{\pathsuris@temp}{\@Colon}[\pathsuris@curruri@scheme]%
        \StrBehind{\pathsuris@temp}{\@Colon}[\pathsuris@temp]%
    }{}%
    % authority
    \IfBeginWith{\pathsuris@temp}{\@Slash\@Slash}{%
        \StrBehind{\pathsuris@temp}{\@Slash\@Slash}[\pathsuris@temp]%
        \IfSubStr{\pathsuris@temp}{\@Slash}{%
            \StrBefore{\pathsuris@temp}{\@Slash}[\pathsuris@curruri@authority]%
            \StrBehind{\pathsuris@temp}{\@Slash}[\pathsuris@temp]%
            % TODO userinfo,host,port
        }{%
            % TODO query,fragment
            \edef\pathsuris@curruri@authority{\pathsuris@temp}%
            \@pathsuris@done@true%
        }%
    }{}%
    % path, query, fragment
    \if@pathsuris@done@\else%
        \IfSubStr{\pathsuris@temp}{\@QuestionMark}{%
            % path
            \StrBefore{\pathsuris@temp}{\@QuestionMark}[\pathsuris@curruri@path]%
            \StrBehind{\pathsuris@temp}{\@QuestionMark}[\pathsuris@temp]%
            % query,fragment
            \IfSubStr{\pathsuris@temp}{\@Fragment}{%
                \StrBefore{\pathsuris@temp}{\@Fragment}[\pathsuris@curruri@query]%
                \StrBehind{\pathsuris@temp}{\@Fragment}[\pathsuris@curruri@fragment]%
            }{%
                \edef\pathsuris@curruri@query{\pathsuris@temp}%
            }%
        }{%
            % path,fragment
            \IfSubStr{\pathsuris@temp}{\@Fragment}{%
                \StrBefore{\pathsuris@temp}{\@Fragment}[\pathsuris@curruri@path]%
                \StrBehind{\pathsuris@temp}{\@Fragment}[\pathsuris@curruri@fragment]%
            }{%
                \edef\pathsuris@curruri@path{\pathsuris@temp}%
            }%
        }%
    \fi%
    %drop trailing slash of path
    %\IfEndWith{\pathsuris@curruri@path}{\@Slash}{%
    %    \StrGobbleRight{\pathsuris@curruri@path}{1}[\pathsuris@curruri@path]
    %}{}%
    %
    %\edef\pathsuris@curruri@path{\cpath{\pathsuris@curruri@path}}%
    \ifx\pathsuris@prefix@temp\@empty\else%
        \expandafter\edef\csname \pathsuris@prefix@temp scheme\endcsname{\pathsuris@curruri@scheme}%
        \expandafter\edef\csname \pathsuris@prefix@temp authority\endcsname{\pathsuris@curruri@authority}%
        \expandafter\edef\csname \pathsuris@prefix@temp path\endcsname{\pathsuris@curruri@path}%
        \expandafter\edef\csname \pathsuris@prefix@temp query\endcsname{\pathsuris@curruri@query}%
        \expandafter\edef\csname \pathsuris@prefix@temp fragment\endcsname{\pathsuris@curruri@fragment}%
    \fi%
}
\newrobustcmd\seturi[1][]{%
    \pathsuris@setcatcodes%
    \expandafter\pathsuris@resetcatcodes\seturi@[#1]%
}
%%% Local Variables:
%%% mode: doctex
%%% TeX-master: t
%%% End:

\endinput
%%
%% End of file `pathsuris.sty'.
